<!--
MedSquare Web
-->
<!DOCTYPE html>
<html>
    <head>
        <title>MedSquare Web</title> 
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <!-- using web libraries
        <script type="text/javascript" src="http://get.goXTK.com/xtk.js"></script>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" />
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>
        -->
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" />
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>
        
        <!--XTK to visualizate medical images, JQuery for the controls -->
        <script type="text/javascript" src="libs/xtk.js"></script>
        <!-- using local libraries (not recommended)
        <link rel="stylesheet" href="jquery-ui.css" />
        <script src="libs/jquery-1.9.1.js"></script>
        <script src="libs/jquery-ui.js"></script> -->
        
        <link rel="stylesheet" href="CSS/main.css">
        <link rel="stylesheet" href="CSS/normalize.css">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script type="text/javascript" src="libs/dat.gui.js"> </script>
        
        <!--Qunit to do automatic tests -->
        <link rel="stylesheet" href="qunit-1.11.0.css"> 
        <script src="libs/qunit-1.11.0.js"></script>
        <script src="tests.js"></script>
    </head>
    <body style="background-color: #000 ">
        
        
        <div id="dialog-mosaic" title="Mosaic visualization">
        <p class="validateTips">All form fields are required.</p>
        <form>
        <fieldset>
            <label for="rows">Rows</label>
            <input type="text" name="rows" id="rows" class="text ui-widget-content ui-corner-all" />
            <label for="columns">Columns</label>
            <input type="text" name="columns" id="columns" value="" class="text ui-widget-content ui-corner-all" />
            <label for="gapping">Gap between slices</label>
            <input type="text" name="gapping" id="gapping" class="text ui-widget-content ui-corner-all" />
        </fieldset>
        </form>
        </div>
        
        <!-- Divs to be used by the 2D renderers-->
        <div style="float: left; width: 30%;height: 95%">
            <br/>
            <div id="axialSlice" 
                 style="height:33%; margin: 2px;margin-right: 10px; color: red"><!-- border-right: solid yellow-->
                XY</div>
            <div id="sagitalSlice" 
                 style="height:33%; margin: 2px; margin-right: 10px; color: green"><!-- border-right: solid red;-->
                YZ</div>
            <div id="coronalSlice" 
                 style="height:33%; margin: 2px; margin-right: 10px; color: blue"><!-- border-right: solid green;-->
                XZ</div>      
        </div>              
        <!-- Divs to be used by the 3D renderer-->
        <div id="3Dslice" style="float:left; width: 50%; height: 500px">            
            <br/>3D
        </div>
        <br/>
        
        
        <script>
            $(function(){
                var rows=$( "#rows" ),
                columns=$( "#columns" ),
                allFields = $( [] ).add( rows ).add( columns );
                $( "#dialog-mosaic" ).dialog({
                  autoOpen: false,
                  height: 300,
                  width: 350,
                  modal: true,
                  buttons: {
                    "Start mosaic mode": function() {
                      var bValid = true;
                      allFields.removeClass( "ui-state-error" );

                      bValid = bValid && checkLength( rows, "rows", 1, 3 );
                      bValid = bValid && checkLength( columns, "columns", 1, 3 );                      

                      bValid = bValid && checkRegexp( rows, /^([0-9]*[1-9][0-9]*)/, "Rows and columns must to be a number different of zero." );
                      // From jquery.validate.js (by joern), contributed by Scott Gonzalez: http://projects.scottsplayground.com/email_address_validation/
                      bValid = bValid && checkRegexp( columns, /^([0-9]*[1-9][0-9]*)/, "Rows and columns must to be a number different of zero." );                      

                      if ( bValid ) {
                        alert('starting mosaic mode')
                        $( this ).dialog( "close" );
                      }
                    },
                    Cancel: function() {
                      $( this ).dialog( "close" );
                    }
                  },
                  close: function() {
                    allFields.val( "" ).removeClass( "ui-state-error" );
                  }
                });

               function checkLength( o, n, min, max ) {
                  if ( o.val().length > max || o.val().length < min ) {
                    o.addClass( "ui-state-error" );
                    updateTips( "Length of " + n + " must be between " +
                      min + " and " + max + "." );
                    return false;
                  } else {
                    return true;
                  }
                }

                function checkRegexp( o, regexp, n ) {
                  if ( !( regexp.test( o.val() ) ) ) {
                    o.addClass( "ui-state-error" );
                    updateTips( n );
                    return false;
                  } else {
                    return true;
                  }
                }

                $( "#mosaic" )
                  .button()
                  .click(function() {
                    $( "#dialog-mosaic" ).dialog( "open" );
                  });
            });
            
        </script>
        
        <script> 
            volume = new X.volume();
            
            function alerta(){
                alert(sessionStorage.getItem("autosave"));
            };
            function showVolume(){
                //alert(sessionStorage.getItem("volumePath"));                
                volume=new X.volume();
                volume.file=sessionStorage.getItem("volumePath");
                updateGUI();
                if (_webGLFriendly) {
                    threeD.destroy();
                    threeD = new X.renderer3D();
                    threeD.container = '3Dslice';
                    threeD.init();
                //threeD.add(volume);
                }
                sliceAxial.add(volume);
                sliceAxial.render();                
            }
            //window.onload = function() {
            
            //window.parent.
            
            
            // try to create the 3D renderer            
            _webGLFriendly = sessionStorage.getItem("webGL");
            try {
                // try to create and initialize a 3D renderer
                threeD = new X.renderer3D();
                threeD.container = '3Dslice';
                threeD.init();
            } catch (Exception) {

                // no webgl on this machine
                _webGLFriendly = false;

            }
            
            // create the 2D renderers
            // here the axial, sagittal and coronal slices corresponds
            // to Z,X,Y orientations resepectively
            sliceAxial = new X.renderer2D();
            sliceAxial.container = 'axialSlice';
            sliceAxial.orientation = 'Z';
            sliceAxial.init();
            //sagital
            sliceSagittal = new X.renderer2D();
            sliceSagittal.container = 'sagitalSlice';
            sliceSagittal.orientation = 'X';
            sliceSagittal.init();
            //coronal
            sliceCoronal = new X.renderer2D();
            sliceCoronal.container = 'coronalSlice';
            sliceCoronal.orientation = 'Y';
            sliceCoronal.init();
            
            //
            // THE VOLUME DATA
            //
            // create a X.volume
            
            volume.file =  'data/sivT1.nii'; // 'http://x.babymri.org/?vol.nrrd'; //'sivT1.nii'; //'data/vessels.nii';//sivT1.nii';//'http://x.babymri.org/?vol.nrrd';
            
            sliceAxial.add(volume);
  
            // start the loading/rendering
            sliceAxial.render();
            
            //building the interfaces
            gui = new dat.GUI();
            
            //creating containers for the controls
            foldNavigation = gui.addFolder('Slice navigation');
            foldWindow= gui.addFolder('Window');
            foldLevel=gui.addFolder('Level');
            foldOther=gui.addFolder('Miscelaneous');
            
            //slices controls
            guiAxial=foldNavigation.add(volume, 'indexZ',0,
                volume.dimensions[2]-1).name('XY');//.__color("#ff0000");
                        
            guiSagital=foldNavigation.add(volume, 'indexX',0,
                volume.dimensions[0]-1).name('YZ');//.background-color("#ff0000");
            guiCoronal=foldNavigation.add(volume, 'indexY',0,
                volume.dimensions[1]-1).name('XZ');
            
            // .. configure the volume rendering opacity
            guiOpacityController = foldOther.add(volume, 'opacity', 0, 1);
              
            guiVolumeController = foldOther.add(volume, 'volumeRendering');
            
            //controls for the window
            guiLowerWindowController = foldWindow.add(volume, 'windowLow', 
                volume.min, volume.max);
            guiUpperWindowController = foldWindow.add(volume, 'windowHigh', 
                volume.min, volume.max);
            
            //controls of level
            guiLowerThresholdController = foldLevel.add(volume, 'lowerThreshold',
                volume.min, volume.max);
            guiUpperThresholdController = foldLevel.add(volume, 'upperThreshold',
                volume.min, volume.max);
                
            foldNavigation.open();
            foldWindow.open();
            foldLevel.open();
            foldOther.open();
            
            // the onShowtime method gets executed after all files were fully loaded and
            // just before the first rendering attempt
            sliceAxial.onShowtime = function() {
                //
                // add the volume to the other 3 renderers
                //
                //alert('onShowtime');
                sliceSagittal.add(volume);                
                sliceCoronal.add(volume);
                

                if (_webGLFriendly) {
                  threeD.add(volume);
                  threeD.render();
                }  
                sliceCoronal.render();
                sliceSagittal.render();
                updateGUI();                
            }; 
            
            //update all GUI controls created with dat-gui
            function updateGUI(){
                //setting max values to the index of slices and the current index
                //alert(volume.indexZ);!!!!!BUG???? .max dont put a value major than the previous max, mmm, nop, si coloca el tamaño, 
                //the volume can't move to higher values
                guiAxial.max(volume.dimensions[2]-1);
                guiAxial.setValue(volume.indexZ);
                guiSagital.max(volume.dimensions[0]-1).setValue(volume.indexX);
                guiCoronal.max(volume.dimensions[1]-1).setValue(volume.indexY);
                
                var minv=volume.min;
                var maxv=volume.max;
                //alert(maxv);
                //setting the max and min values for the window level controls
                guiLowerThresholdController.min(minv).max(maxv).setValue(minv);
                guiUpperThresholdController.min(minv).max(maxv).setValue(maxv);
                guiLowerWindowController.min(minv).max(maxv).setValue(minv);
                guiUpperWindowController.min(minv).max(maxv).setValue(maxv);
            };
            $("#btnOpen").click(function(){
               loadFileImage();
            });
            $("#btnUpdate").click(function(){
               updateGUI(); 
            });
            
            
            function loadFileImage(){ 
                //alert('leyendo');
                volume=new X.volume();
                volume.file = 'http://x.babymri.org/?vol.nrrd';//'data/vessels.nii';
                //sliceAxial.destroy();
                //sliceAxial = new X.renderer2D();
                //sliceAxial.container = 'axialSlice';
                //sliceAxial.orientation = 'Z';                
                //sliceAxial.init();
                
                //It is necessary to load information from the volume before
                //renderings, it is a library bug
                updateGUI();
                
                if (_webGLFriendly) {
                    threeD.destroy();
                    threeD = new X.renderer3D();
                    threeD.container = '3Dslice';
                    threeD.init();
                //threeD.add(volume);
                }
                sliceAxial.add(volume);
                
                //sliceSagittal.add(volume);
                //sliceCoronal.add(volume);
                
                //threeD.add(volume);
                //threeD.resetViewAndRender();
                //updateGUI();
                sliceAxial.render();                
            }; 
            
            
            //};
            </script>
    </body>
</html>
