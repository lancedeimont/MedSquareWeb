<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <title>MedSquare Web</title> 
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css" />
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>

        <!--XTK to visualizate medical images, JQuery for the controls -->
        <script type="text/javascript" src="libs/xtk.js"></script>

        <link rel="stylesheet" href="CSS/main.css">
        <link rel="stylesheet" href="CSS/normalize.css">
        <link rel="stylesheet" href="CSS/mainCss.css">
        <link rel="stylesheet" href="CSS/visualization.css">

        <script type="text/javascript" src="libs/dat.gui.js"></script>
        <script src="js/msqfunctions.js"></script> 

    </head>
    <body>
        <div id="mosaicDiv"></div>

        <script>

            rows = loadParammeter("rows");
            columns = loadParammeter("columns");
            gapping = loadParammeter("gapping");

            initialSlice = 0;
            orientation = 'Z';
            norientation = 2;
            volume = new X.volume();

            volume.file = loadParammeter("volumePath");
            volume.indexZ = initialSlice;
            slice = new X.renderer2D();
            slice.orientation = orientation;

            volumet = new X.volume();
            slicet = new X.renderer2D();

            renderers = [];
            volumes = [];
            volumes.push(volume);
            //createDivs(rows,columns);

            function createDivs(nrow, ncol) {
                widthDiv = $(window).width() / ncol;
                //-100 because the header
                heightDiv = ($(window).height() - 100) / nrow;

                for (var i = 0; i < ncol; i++)
                    for (var j = 0; j < nrow; j++)
                    {
                        var nameDiv = "div" + i + "x" + j;
                        $('<div>', {
                            id: nameDiv,
                            style: "float: left; width :" + widthDiv + "px; height:" + heightDiv + "px;",
                            //html: "div" + i + "x" + j
                        }).appendTo('#mosaicDiv');

                        if (i == 0 && j == 0)//it is the first div, load the volume
                        {
                            slice.container = nameDiv;
                            slice.init();
                            slice.add(volume);
                            slice.render();
                            renderers.push(slice);
                        }
                    }
                    
            }

            

            function createRenderers(nrow, ncol)
            {
                var sizeVolume = volumet.dimensions[norientation];
                //indice do volume atual                
                for (var i = 0; i < ncol; i++)
                    for (var j = 0; j < nrow; j++)
                    {
                        if (i != 0 || j != 0)//the first renderer was already created
                        {
                            var nameDiv = "div" + i + "x" + j;
                            slicet = new X.renderer2D();
                            volumet = new X.volume();
                            var indx = (i * nrow + j) * gapping;
                            //if it is the last slice show the last slice in the volume
                            if ((i == ncol - 1) && (j == nrow - 1))
                                indx = sizeVolume - 1;
                            renderers.push(create2DRender(nameDiv, indx));
                        }
                    }
            }
            function create2DRender(container, index)
            {
                slicet.container = container;
                slicet.orientation = orientation;
                slicet.init();

                //volumet.fileData = volumes[0].image; //It is not possible in XTK

                volumet.file = loadParammeter("volumePath");
                volumes.push(volumet);//add a volume if it is not the 
                //last div (one more was added innitially)

                slicet.add(volumet);
                //slicet.render();
                volumet.indexZ = index;
                return slicet;
            }

            function loadParammeter(v) {
                return sessionStorage.getItem(v);
            }

            function renderSlices() {
                for (var j = 0; j < rows; j++)
                    for (var i = 0; i < columns; i++)//FIXME i< .. +1?
                    {
                        var ind=i+j*columns;
                        renderers[ind].render();                        
                        volumes[ind].indexZ=sliceIndex(i, j, rows, columns, gapping,volumet.dimensions[norientation]);
                    }
            }


            window.onload = function() {
                createDivs(rows, columns);

                //renderers[0].render();      
//                renderSlices();
                //when the first renderer is loaded all the others will be rendered
                createRenderers(rows, columns);
                slice.onShowtime = function() {
                    
                    renderSlices();
                };
            };
        </script>
    </body>
</html>
