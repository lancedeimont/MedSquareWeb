<!DOCTYPE html>
<html>
    <head>
        <title>MedSquare Web</title> 
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

        <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.1/themes/base/jquery-ui.css">
        <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
        <!-- using web libraries
        <script src="http://code.jquery.com/ui/1.10.1/jquery-ui.js"></script>-->
        <!-- using local libraries-->
        <script src="libs/jquery-ui.js"></script> 

        <!--XTK to visualizate medical images, JQuery for the controls -->
        <script type="text/javascript" src="libs/xtk.js"></script>
        <script src="js/msqfunctions.js"></script> 

        <link rel="stylesheet" href="CSS/main.css">
        <link rel="stylesheet" href="CSS/normalize.css">
        <link rel="stylesheet" href="CSS/mainCss.css">

        <script type="text/javascript" src="libs/dat.gui.js"></script>

        <!--Qunit to do automatic tests -->
        <link rel="stylesheet" href="qunit-1.11.0.css"> 
        <script src="libs/qunit-1.11.0.js"></script>
        <script src="tests/tests.js"></script>

        <script>
            //global variables
            //modes: 0=MPR, 1=mosaic, -1=any page without a special mode
            mode = 0;
            //defines if the browser can use WebGl
            _webGLFriendly = true;
            currentImage = 'data/sivT1.nii';

            sessionStorage.setItem("webGL", true);
            volume = new X.volume();
            tst = "principal";

            sessionStorage.setItem("volumePath", currentImage);
            //functions to show the mosaic dialog
            $(function() {
                var rows = $("#rows"),
                        columns = $("#columns"),
                        gapping = $("#gappingTxt"),
                        allFields = $([]).add(rows).add(columns);
                $("#dialog-mosaic").dialog({
                    autoOpen: false,
                    height: 330,
                    width: 400,
                    modal: true,
                    buttons: {
                        "Start mosaic mode": function() {
                            var bValid = true;
                            allFields.removeClass("ui-state-error");

                            bValid = bValid && checkLength(rows, "rows", 1, 2);
                            bValid = bValid && checkLength(columns, "columns", 1, 2);

                            // From jquery.validate.js (by joern), contributed by Scott Gonzalez: http://projects.scottsplayground.com/email_address_validation/
                            bValid = bValid && checkRegexp(rows, /^([0-9]*[1-9][0-9]*)/, "Rows and columns must to be a number different of zero.");
                            bValid = bValid && checkRegexp(columns, /^([0-9]*[1-9][0-9]*)/, "Rows and columns must to be a number different of zero.");

                            if (bValid) {//starting mosaic mode
                                //saving values to session variables
                                sessionStorage.setItem("rows", rows.val());
                                sessionStorage.setItem("columns", columns.val());

                                if ($("#automaticCB").is(":checked"))
                                    sessionStorage.setItem("gapping", "-1");
                                else
                                    sessionStorage.setItem("gapping", $("#gappingTxt").val());
                                sessionStorage.setItem("volumePath", currentImage)

                                $(this).dialog("close");
                                //load page of mosaic view
                                var ifrm = document.getElementById("frVisualiz");
                                ifrm.setAttribute("src", "mosaicView.html?rows=" + rows + "&columns=" + columns);
                                mode = 1;
                                
                                //show and hide buttons in the menu
                                $("#btnMosaic").hide();
                                $("#btnMPR").show();
                            } else
                            {
                                alert('The values must to be numbers');
                            }
                        },
                        Cancel: function() {
                            $(this).dialog("close");
                        }
                    },
                    close: function() {
                        allFields.val("").removeClass("ui-state-error");
                    }

                });



                function checkRegexp(o, regexp, n) {
                    if (!(regexp.test(o.val()))) {
                        o.addClass("ui-state-error");
                        updateTips(n);
                        return false;
                    } else {
                        return true;
                    }
                }

                $("#automaticCB").click(function() {

                    if ($("#automaticCB").is(":checked"))
                    {
                        $("#labGapping").attr('disabled', true);
                        $("#gappingTxt").attr('disabled', true).parent().css({color: '#ccc'});
                    }
                    else
                    {
                        $("#labGapping").attr('disabled', false);
                        $("#gappingTxt").attr('disabled', false).parent().css({color: '#000'});
                    }

                });
            });

            //loads an image saved in the server
            function loadWebFile(filePath) {
                //volume=new X.volume();
                //volume.file = filePath;
                currentImage = filePath;
                sessionStorage.setItem("volumePath", filePath);

            }
            ;

            $(function() {
                $("#btnOpen").button().click(function() {

                    loadWebFile('http://x.babymri.org/?vol.nrrd');
                    if (mode === 0)
                        document.getElementById('frVisualiz').contentWindow.showVolume();
                });
                $("#btnMPR").button().click(function() {
                    if (mode !== 0)//it is not in mpr mode
                    {
                        var ifrm = document.getElementById("frVisualiz");
                        ifrm.setAttribute("src", "visualization.html");
                        mode = 0;                        
                        $("#btnMPR").hide();
                        $("#btnMosaic").show();
                    }
                });
                $("#btnMosaic").button().click(function() {
                    if (mode !== 1)//currently we are in mpr mode loading mosaic
                    {//show a dialog and load mosaic view
                        $("#dialog-mosaic").dialog("open");
                    }
                });

                $("#btnUpdate").button().click(function() {

                });
                $("#btnAbout").button().click(function() {
                    var ifrm = document.getElementById("frVisualiz");
                    ifrm.setAttribute("src", "about.html");
                    $("#btnMPR").show();
                    $("#btnMosaic").show();
                    mode=-1;
                });
            });
            window.onload = function() {
                $("#btnMPR").hide();
            };
        </script>
    </head>

    <body>
        <header class="logo">
            <img src="images/MedsquareWeb_logo.png" alt="MedSquareWeb logo">
        </header>
        <nav class="tools">
            <button id="btnOpen" class="tool">Open</button>
            <button id="btnUpdate" class="tool">Update</button>
            <button id="btnMPR" class="tool" hidden="hidden">MPR Mode</button>
            <button id="btnMosaic" class="tool">Mosaic Mode</button>
            <button id="btnAbout" class="tool" style="float:right;"><img src="images/iconInter.png" height="26" alt="about"></button>

        </nav>
        <div id="dialog-mosaic" title="Mosaic visualization">
            <p class="validateTips">All form fields are required.</p>
            <form>
                <fieldset>
                    <label class="image-information-field">
                        Rows
                        <input type="text" name="rows" id="rows" class="text ui-widget-content ui-corner-all" />
                    </label>
                    <label class="image-information-field">
                        Columns
                        <input type="text" name="columns" id="columns" value="" class="text ui-widget-content ui-corner-all" />
                    </label>
                    <label>
                        <input type="checkbox" name="automatic" id="automaticCB" checked="checked" class="text ui-widget-content ui-corner-all"/>
                        Automatic gap
                    </label>
                    <label class="image-information-field" id="labGapping">
                        Gap between slices
                        <input type="text" name="gappingTxt" id="gappingTxt" class="text ui-widget-content ui-corner-all" style="color:#ccc" />
                    </label>
                </fieldset>
            </form>
        </div>
        <!-- maindiv should be  bug in netbeans, do not recognize main-->

        <div id="mainDiv">
            <iframe id="frVisualiz" src="visualization.html" style="width: 100%; height: 600px"></iframe>
        </div>

        <!-- Divs for tests
        <div style="width: 100%; position: absolute; top: 900px">
            <div id="qunit">
            </div>
            <div id="qunit-fixture" style="width: 100%"></div>
        </div>-->
    </body>
</html>
